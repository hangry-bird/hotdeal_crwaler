name: 핫딜 크롤러

on:
  # 주기적으로 실행 (cron 형식)
  schedule:
    # 매 30분마다 실행 (한국 시간 07:00~다음날 00:30까지)
    # 한국 시간 07:00~00:30 = UTC 22:00~15:30
    # UTC: 00:00~15:30 (한국 09:00~00:30) + 22:00~23:30 (한국 07:00~08:30)
    - cron: '*/30 0-15,22-23 * * *'
  
  # 수동 실행 가능
  workflow_dispatch:

jobs:
  crawl:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # state.json 커밋을 위한 쓰기 권한
    
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v3
      
      - name: Node.js 설정
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: 의존성 설치
        run: npm ci
        env:
          PUPPETEER_SKIP_DOWNLOAD: 'false'
          PUPPETEER_CACHE_DIR: ~/.cache/puppeteer
      
      - name: Puppeteer Chrome 설치
        run: npx puppeteer browsers install chrome
      
      - name: TypeScript 빌드
        run: npm run build
      
      - name: 크롤러 실행
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: npm start
      
      - name: 상태 파일 커밋 (변경사항이 있는 경우)
        if: github.event_name == 'schedule'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add state.json || true
          git diff --staged --quiet || git commit -m "Update state.json [skip ci]"
          git push || true

